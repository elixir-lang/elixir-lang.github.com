<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Doctests, patterns and with - Elixir</title>
  <link href="http://feeds.feedburner.com/ElixirLang" rel="alternate" title="Elixir's Blog" type="application/atom+xml" />
  <link rel="stylesheet" type="text/css" href="/css/style.css" />
  <link rel="stylesheet" type="text/css" href="/css/syntax.css" />
  <link rel="stylesheet" href="/js/icons/style.css">
  <!--[if lt IE 8]><!-->
  <link rel="stylesheet" href="/js/icons/ie7/ie7.css">
  <!--<![endif]-->
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" id="font-bitter-css" href="//fonts.googleapis.com/css?family=Bitter:400,700" type="text/css" media="screen" />
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="search" type="application/opensearchdescription+xml" title="elixir-lang.org" href="/opensearch.xml" />
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-8268430-6', 'auto');
  ga('send', 'pageview');
  </script>
  <!-- Begin Jekyll SEO tag v2.2.3 -->
<meta property="og:title" content="Doctests, patterns and with" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="https://elixir-lang.org/ja/getting-started/mix-otp/docs-tests-and-with.html" />
<meta property="og:url" content="https://elixir-lang.org/ja/getting-started/mix-otp/docs-tests-and-with.html" />
<script type="application/ld+json">
{"@context":"http://schema.org","@type":"WebPage","headline":"Doctests, patterns and with","url":"https://elixir-lang.org/ja/getting-started/mix-otp/docs-tests-and-with.html"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body class="">
  <div id="container">
    <div class="wrap">
    <div id="header">
      <div id="branding">
        <a id="site-title" href="/" title="Elixir" rel="Home">
          <img class="logo" src="/images/logo/logo.png" alt="Elixir Logo" />
        </a>
      </div>

      <div id="menu-primary" class="menu-container">
        <div class="menu">
          <ul id="menu-primary-items">
            <li class="menu-item home"><a class="spec" href="/">Home</a></li>
            <li class="menu-item install"><a class="spec" href="/install.html">Install</a></li>
            <li class="menu-item getting-started"><a class="spec" href="/getting-started/introduction.html">Guides</a></li>
            <li class="menu-item learning"><a class="spec" href="/learning.html">Learning</a></li>
            <li class="menu-item docs"><a class="spec" href="/docs.html">Docs</a></li>
            <li class="menu-item development"><a class="spec" href="/development.html">Development</a></li>
            <li class="menu-item blog"><a class="spec" href="/blog/">Blog</a></li>
            <li class="menu-item packages"><a class="spec" href="https://hex.pm/">Packages</a></li>
          </ul>
        </div>
      </div>

      <div class="clear"></div>
    </div>

    <div id="main">


<div id="sidebar-primary" class="sidebar">
  <div class="widget news">
  <h3>
    News: <a href="/blog/2018/07/25/elixir-v1-7-0-released/">Elixir v1.7 released</a>
  </h3>
</div>

<div class="widget search">
  <form method="get" id="search-form" class="search-form" action="https://www.google.com/search">
		<div>
			<input class="search-text" type="text" name="q" placeholder="Search..." id="searchfield" aria-label="Search box">
			<input type="hidden" name="sitesearch" value="elixir-lang.org">
			<input class="search-submit button" name="submit" type="submit" value="Search" aria-label="Search button">
		</div>
	</form>
</div>

  <div id="mini-docu" class="widget">
  <a href="http://doc.honeypot.io/elixir-documentary-2018/?utm_source=elixir_home&utm_medium=referral">
    <div class="mini-docu-cta">
      <div class="mini-docu-copy">Watch the Elixir<br />mini-documentary!</div>
    </div>
  </a>
</div>


  
  
    <div class="widget">
     <h3 class="widget-title">Getting Started</h3>
      <ol>
        
          <li><a class="spec" href="/getting-started/introduction.html" title="Introduction">Introduction</a></li>
        
          <li><a class="spec" href="/getting-started/basic-types.html" title="Basic types">Basic types</a></li>
        
          <li><a class="spec" href="/getting-started/basic-operators.html" title="Basic operators">Basic operators</a></li>
        
          <li><a class="spec" href="/getting-started/pattern-matching.html" title="Pattern matching">Pattern matching</a></li>
        
          <li><a class="spec" href="/getting-started/case-cond-and-if.html" title="case, cond and if">case, cond and if</a></li>
        
          <li><a class="spec" href="/getting-started/binaries-strings-and-char-lists.html" title="Binaries, strings and char lists">Binaries, strings and char lists</a></li>
        
          <li><a class="spec" href="/getting-started/keywords-and-maps.html" title="Keywords and maps">Keywords and maps</a></li>
        
          <li><a class="spec" href="/getting-started/modules-and-functions.html" title="Modules and Functions">Modules and Functions</a></li>
        
          <li><a class="spec" href="/getting-started/recursion.html" title="Recursion">Recursion</a></li>
        
          <li><a class="spec" href="/getting-started/enumerables-and-streams.html" title="Enumerables and streams">Enumerables and streams</a></li>
        
          <li><a class="spec" href="/getting-started/processes.html" title="Processes">Processes</a></li>
        
          <li><a class="spec" href="/getting-started/io-and-the-file-system.html" title="IO and the file system">IO and the file system</a></li>
        
          <li><a class="spec" href="/getting-started/alias-require-and-import.html" title="alias, require and import">alias, require and import</a></li>
        
          <li><a class="spec" href="/getting-started/module-attributes.html" title="Module attributes">Module attributes</a></li>
        
          <li><a class="spec" href="/getting-started/structs.html" title="Structs">Structs</a></li>
        
          <li><a class="spec" href="/getting-started/protocols.html" title="Protocols">Protocols</a></li>
        
          <li><a class="spec" href="/getting-started/comprehensions.html" title="Comprehensions">Comprehensions</a></li>
        
          <li><a class="spec" href="/getting-started/sigils.html" title="Sigils">Sigils</a></li>
        
          <li><a class="spec" href="/getting-started/try-catch-and-rescue.html" title="try, catch and rescue">try, catch and rescue</a></li>
        
          <li><a class="spec" href="/getting-started/typespecs-and-behaviours.html" title="Typespecs and behaviours">Typespecs and behaviours</a></li>
        
          <li><a class="spec" href="/getting-started/debugging.html" title="Debugging">Debugging</a></li>
        
          <li><a class="spec" href="/getting-started/erlang-libraries.html" title="Erlang libraries">Erlang libraries</a></li>
        
          <li><a class="spec" href="/getting-started/where-to-go-next.html" title="Where to go next">Where to go next</a></li>
        
      </ol>
    </div>
  
    <div class="widget">
     <h3 class="widget-title">Mix and OTP</h3>
      <ol>
        
          <li><a class="spec" href="/getting-started/mix-otp/introduction-to-mix.html" title="Introduction to Mix">Introduction to Mix</a></li>
        
          <li><a class="spec" href="/getting-started/mix-otp/agent.html" title="Agent">Agent</a></li>
        
          <li><a class="spec" href="/getting-started/mix-otp/genserver.html" title="GenServer">GenServer</a></li>
        
          <li><a class="spec" href="/getting-started/mix-otp/supervisor-and-application.html" title="Supervisor and Application">Supervisor and Application</a></li>
        
          <li><a class="spec" href="/getting-started/mix-otp/dynamic-supervisor.html" title="DynamicSupervisor">DynamicSupervisor</a></li>
        
          <li><a class="spec" href="/getting-started/mix-otp/ets.html" title="ETS">ETS</a></li>
        
          <li><a class="spec" href="/getting-started/mix-otp/dependencies-and-umbrella-projects.html" title="Dependencies and umbrella projects">Dependencies and umbrella projects</a></li>
        
          <li><a class="spec" href="/getting-started/mix-otp/task-and-gen-tcp.html" title="Task and gen_tcp">Task and gen_tcp</a></li>
        
          <li><a class="spec" href="/getting-started/mix-otp/docs-tests-and-with.html" title="Doctests, patterns and with">Doctests, patterns and with</a></li>
        
          <li><a class="spec" href="/getting-started/mix-otp/distributed-tasks-and-configuration.html" title="Distributed tasks and configuration">Distributed tasks and configuration</a></li>
        
      </ol>
    </div>
  
    <div class="widget">
     <h3 class="widget-title">Meta-programming in Elixir</h3>
      <ol>
        
          <li><a class="spec" href="/getting-started/meta/quote-and-unquote.html" title="Quote and unquote">Quote and unquote</a></li>
        
          <li><a class="spec" href="/getting-started/meta/macros.html" title="Macros">Macros</a></li>
        
          <li><a class="spec" href="/getting-started/meta/domain-specific-languages.html" title="Domain Specific Languages">Domain Specific Languages</a></li>
        
      </ol>
    </div>
  

  <div id="elixir-radar" class="widget">
  <h3 class="widget-title">Elixir Radar Newsletter</h3>
  <p>A weekly Elixir email newsletter with content curated by Plataformatec.</p>
  <div class="elixir-radar-cta">
    <div class="cta-copy">
      <div class="cta-title">
        Elixir Radar
      </div>
      <div class="cta-subtitle">
        weekly newsletter
      </div>
    </div>
    <div class="cta-button-container">
      <a href="http://plataformatec.com.br/elixir-radar/weekly-newsletter?utm_campaign=elixir_lang_cta&utm_medium=cta&utm_source=elixir_lang_website" class="cta-button">
        Subscribe now
      </a>
    </div>
  </div>
</div>

  <div id="distilled-by" class="widget">
  <h3 class="widget-title">Created at</h3>
  <ul>
    <li class="image"><a href="http://plataformatec.com.br" title="Plataformatec"><img src="/images/logo/plataformatec.png" alt="Plataformatec Logo" width="190" height="74" /></a></li>
  </ul>

  <p>
    <a class="spec" href="http://plataformatec.com.br">Plataformatec</a> offers consulting and development services for companies using Elixir.
  </p>
</div>

</div>

<div id="content">
  <article>
    <h1 id="doctests-patterns-and-with">Doctests, patterns and with</h1>

<div id="toc" class="toc"></div>

<blockquote>
  <p>This chapter is part of the <i>Mix and OTP guide</i> and it depends on previous chapters in this guide.
For more information, <a href="/getting-started/mix-otp/introduction-to-mix.html">read the introduction guide</a> or check out the chapter index in the sidebar.</p>
</blockquote>

<p>In this chapter, we will implement the code that parses the commands we described in the first chapter:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>CREATE shopping
OK

PUT shopping milk 1
OK

PUT shopping eggs 3
OK

GET shopping milk
1
OK

DELETE shopping eggs
OK
</code></pre>
</div>

<p>After the parsing is done, we will update our server to dispatch the parsed commands to the <code class="highlighter-rouge">:kv</code> application we built previously.</p>

<h2 id="doctests">Doctests</h2>

<p>On the language homepage, we mention that Elixir makes documentation a first-class citizen in the language. We have explored this concept many times throughout this guide, be it via <code class="highlighter-rouge">mix help</code> or by typing <code class="highlighter-rouge">h Enum</code> or another module in an IEx console.</p>

<p>In this section, we will implement the parsing functionality, document it and make sure our documentation is up to date with doctests. This helps us provide documentation with accurate code samples.</p>

<p>Let’s create our command parser at <code class="highlighter-rouge">lib/kv_server/command.ex</code> and start with the doctest:</p>

<div class="language-elixir highlighter-rouge"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">KVServer</span><span class="o">.</span><span class="no">Command</span> <span class="k">do</span>
  <span class="nv">@doc</span> <span class="err">~</span><span class="no">S</span><span class="sd">"""
  Parses the given `line` into a command.

  ## Examples

      iex&gt; KVServer.Command.parse("CREATE shopping\r\n")
      {:ok, {:create, "shopping"}}

  """</span>
  <span class="k">def</span> <span class="n">parse</span><span class="p">(</span><span class="n">_line</span><span class="p">)</span> <span class="k">do</span>
    <span class="ss">:not_implemented</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Doctests are specified by an indentation of four spaces followed by the <code class="highlighter-rouge">iex&gt;</code> prompt in a documentation string. If a command spans multiple lines, you can use <code class="highlighter-rouge">...&gt;</code>, as in IEx. The expected result should start at the next line after <code class="highlighter-rouge">iex&gt;</code> or <code class="highlighter-rouge">...&gt;</code> line(s) and is terminated either by a newline or a new <code class="highlighter-rouge">iex&gt;</code> prefix.</p>

<p>Also, note that we started the documentation string using <code class="highlighter-rouge">@doc ~S"""</code>. The <code class="highlighter-rouge">~S</code> prevents the <code class="highlighter-rouge">\r\n</code> characters from being converted to a carriage return and line feed until they are evaluated in the test.</p>

<p>To run our doctests, we’ll create a file at <code class="highlighter-rouge">test/kv_server/command_test.exs</code> and call <code class="highlighter-rouge">doctest KVServer.Command</code> in the test case:</p>

<div class="language-elixir highlighter-rouge"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">KVServer</span><span class="o">.</span><span class="no">CommandTest</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">ExUnit</span><span class="o">.</span><span class="no">Case</span><span class="p">,</span> <span class="ss">async:</span> <span class="no">true</span>
  <span class="n">doctest</span> <span class="no">KVServer</span><span class="o">.</span><span class="no">Command</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Run the test suite and the doctest should fail:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  1) test doc at KVServer.Command.parse/1 (1) (KVServer.CommandTest)
     test/kv_server/command_test.exs:3
     Doctest failed
     code: KVServer.Command.parse "CREATE shopping\r\n" === {:ok, {:create, "shopping"}}
     lhs:  :not_implemented
     stacktrace:
       lib/kv_server/command.ex:7: KVServer.Command (module)
</code></pre>
</div>

<p>Excellent!</p>

<p>Now let’s make the doctest pass. Let’s implement the <code class="highlighter-rouge">parse/1</code> function:</p>

<div class="language-elixir highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="n">parse</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">do</span>
  <span class="k">case</span> <span class="no">String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">[</span><span class="sd">"</span><span class="s2">CREATE"</span><span class="p">,</span> <span class="n">bucket</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="p">{</span><span class="ss">:create</span><span class="p">,</span> <span class="n">bucket</span><span class="p">}}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Our implementation splits the line on whitespace and then matches the command against a list. Using <code class="highlighter-rouge">String.split/1</code> means our commands will be whitespace-insensitive. Leading and trailing whitespace won’t matter, nor will consecutive spaces between words. Let’s add some new doctests to test this behaviour along with the other commands:</p>

<div class="language-elixir highlighter-rouge"><pre class="highlight"><code><span class="nv">@doc</span> <span class="err">~</span><span class="no">S</span><span class="sd">"""
Parses the given `line` into a command.

## Examples

    iex&gt; KVServer.Command.parse "CREATE shopping\r\n"
    {:ok, {:create, "shopping"}}

    iex&gt; KVServer.Command.parse "CREATE  shopping  \r\n"
    {:ok, {:create, "shopping"}}

    iex&gt; KVServer.Command.parse "PUT shopping milk 1\r\n"
    {:ok, {:put, "shopping", "milk", "1"}}

    iex&gt; KVServer.Command.parse "GET shopping milk\r\n"
    {:ok, {:get, "shopping", "milk"}}

    iex&gt; KVServer.Command.parse "DELETE shopping eggs\r\n"
    {:ok, {:delete, "shopping", "eggs"}}

Unknown commands or commands with the wrong number of
arguments return an error:

    iex&gt; KVServer.Command.parse "UNKNOWN shopping eggs\r\n"
    {:error, :unknown_command}

    iex&gt; KVServer.Command.parse "GET shopping\r\n"
    {:error, :unknown_command}

"""</span>
</code></pre>
</div>

<p>With doctests at hand, it is your turn to make tests pass! Once you’re ready, you can compare your work with our solution below:</p>

<div class="language-elixir highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="n">parse</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">do</span>
  <span class="k">case</span> <span class="no">String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">[</span><span class="sd">"</span><span class="s2">CREATE"</span><span class="p">,</span> <span class="n">bucket</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="p">{</span><span class="ss">:create</span><span class="p">,</span> <span class="n">bucket</span><span class="p">}}</span>
    <span class="p">[</span><span class="sd">"</span><span class="s2">GET"</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="p">{</span><span class="ss">:get</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">}}</span>
    <span class="p">[</span><span class="sd">"</span><span class="s2">PUT"</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="p">{</span><span class="ss">:put</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">}}</span>
    <span class="p">[</span><span class="sd">"</span><span class="s2">DELETE"</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="p">{</span><span class="ss">:delete</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">}}</span>
    <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="ss">:unknown_command</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Notice how we were able to elegantly parse the commands without adding a bunch of <code class="highlighter-rouge">if/else</code> clauses that check the command name and number of arguments!</p>

<p>Finally, you may have observed that each doctest corresponds to a different test in our suite, which now reports a total of 7 doctests. That is because ExUnit considers the following to define two different doctests:</p>

<pre><code class="language-iex">iex&gt; KVServer.Command.parse("UNKNOWN shopping eggs\r\n")
{:error, :unknown_command}

iex&gt; KVServer.Command.parse("GET shopping\r\n")
{:error, :unknown_command}
</code></pre>

<p>Without new lines, as seen below, ExUnit compiles it into a single doctest:</p>

<pre><code class="language-iex">iex&gt; KVServer.Command.parse("UNKNOWN shopping eggs\r\n")
{:error, :unknown_command}
iex&gt; KVServer.Command.parse("GET shopping\r\n")
{:error, :unknown_command}
</code></pre>

<p>As the name says, doctest is documentation first and a test later. Their goal is not to replace tests but to provide up to date documentation. You can read more about doctests in <a href="https://hexdocs.pm/ex_unit/ExUnit.DocTest.html">the <code class="highlighter-rouge">ExUnit.DocTest</code> docs</a>.</p>

<h2 id="with">with</h2>

<p>As we are now able to parse commands, we can finally start implementing the logic that runs the commands. Let’s add a stub definition for this function for now:</p>

<div class="language-elixir highlighter-rouge"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">KVServer</span><span class="o">.</span><span class="no">Command</span> <span class="k">do</span>
  <span class="nv">@doc</span> <span class="sd">"""
  Runs the given command.
  """</span>
  <span class="k">def</span> <span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="sd">"</span><span class="s2">OK\r\n"</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Before we implement this function, let’s change our server to start using our new <code class="highlighter-rouge">parse/1</code> and <code class="highlighter-rouge">run/1</code> functions. Remember, our <code class="highlighter-rouge">read_line/1</code> function was also crashing when the client closed the socket, so let’s take the opportunity to fix it, too. Open up <code class="highlighter-rouge">lib/kv_server.ex</code> and replace the existing server definition:</p>

<div class="language-elixir highlighter-rouge"><pre class="highlight"><code><span class="k">defp</span> <span class="n">serve</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">socket</span>
  <span class="o">|&gt;</span> <span class="n">read_line</span><span class="p">()</span>
  <span class="o">|&gt;</span> <span class="n">write_line</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>

  <span class="n">serve</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">defp</span> <span class="n">read_line</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
  <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">data</span><span class="p">}</span> <span class="o">=</span> <span class="ss">:gen_tcp</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span>
  <span class="n">data</span>
<span class="k">end</span>

<span class="k">defp</span> <span class="n">write_line</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
  <span class="ss">:gen_tcp</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>by the following:</p>

<div class="language-elixir highlighter-rouge"><pre class="highlight"><code><span class="k">defp</span> <span class="n">serve</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">msg</span> <span class="o">=</span>
    <span class="k">case</span> <span class="n">read_line</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
      <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">data</span><span class="p">}</span> <span class="o">-&gt;</span>
        <span class="k">case</span> <span class="no">KVServer</span><span class="o">.</span><span class="no">Command</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">do</span>
          <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">command</span><span class="p">}</span> <span class="o">-&gt;</span>
            <span class="no">KVServer</span><span class="o">.</span><span class="no">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
          <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="n">_</span><span class="p">}</span> <span class="o">=</span> <span class="n">err</span> <span class="o">-&gt;</span>
            <span class="n">err</span>
        <span class="k">end</span>
      <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="n">_</span><span class="p">}</span> <span class="o">=</span> <span class="n">err</span> <span class="o">-&gt;</span>
        <span class="n">err</span>
    <span class="k">end</span>

  <span class="n">write_line</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
  <span class="n">serve</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">defp</span> <span class="n">read_line</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
  <span class="ss">:gen_tcp</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">defp</span> <span class="n">write_line</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">text</span><span class="p">})</span> <span class="k">do</span>
  <span class="ss">:gen_tcp</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">defp</span> <span class="n">write_line</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="ss">:unknown_command</span><span class="p">})</span> <span class="k">do</span>
  <span class="c1"># Known error. Write to the client.</span>
  <span class="ss">:gen_tcp</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">UNKNOWN COMMAND\r\n"</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">defp</span> <span class="n">write_line</span><span class="p">(</span><span class="n">_socket</span><span class="p">,</span> <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="ss">:closed</span><span class="p">})</span> <span class="k">do</span>
  <span class="c1"># The connection was closed, exit politely.</span>
  <span class="k">exit</span><span class="p">(</span><span class="ss">:shutdown</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">defp</span> <span class="n">write_line</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="n">error</span><span class="p">})</span> <span class="k">do</span>
  <span class="c1"># Unknown error. Write to the client and exit.</span>
  <span class="ss">:gen_tcp</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">ERROR\r\n"</span><span class="p">)</span>
  <span class="k">exit</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>If we start our server, we can now send commands to it. For now, we will get two different responses: “OK” when the command is known and “UNKNOWN COMMAND” otherwise:</p>

<div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">telnet</span><span class="kv"> 127.0.0.1 4040
</span>Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
CREATE shopping
OK
HELLO
UNKNOWN COMMAND
</code></pre>
</div>

<p>This means our implementation is going in the correct direction, but it doesn’t look very elegant, does it?</p>

<p>The previous implementation used pipelines which made the logic straightforward to follow. However, now that we need to handle different error codes along the way, our server logic is nested inside many <code class="highlighter-rouge">case</code> calls.</p>

<p>Thankfully, Elixir v1.2 introduced the <code class="highlighter-rouge">with</code> construct, which allows you to simplify code like the above, replacing nested <code class="highlighter-rouge">case</code> calls with a chain of matching clauses. Let’s rewrite the <code class="highlighter-rouge">serve/1</code> function to use <code class="highlighter-rouge">with</code>:</p>

<div class="language-elixir highlighter-rouge"><pre class="highlight"><code><span class="k">defp</span> <span class="n">serve</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">msg</span> <span class="o">=</span>
    <span class="n">with</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">data</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="n">read_line</span><span class="p">(</span><span class="n">socket</span><span class="p">),</span>
         <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">command</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="no">KVServer</span><span class="o">.</span><span class="no">Command</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
         <span class="k">do</span><span class="p">:</span> <span class="no">KVServer</span><span class="o">.</span><span class="no">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

  <span class="n">write_line</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
  <span class="n">serve</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Much better! <code class="highlighter-rouge">with</code> will retrieve the value returned by the right-side of <code class="highlighter-rouge">&lt;-</code> and match it against the pattern on the left side. If the value matches the pattern, <code class="highlighter-rouge">with</code> moves on to the next expression. In case there is no match, the non-matching value is returned.</p>

<p>In other words, we converted each expression given to <code class="highlighter-rouge">case/2</code> as a step in <code class="highlighter-rouge">with</code>. As soon as any of the steps return something that does not match <code class="highlighter-rouge"><span class="p">{</span><span class="err">:ok,</span><span class="w"> </span><span class="err">x</span><span class="p">}</span></code>, <code class="highlighter-rouge">with</code> aborts, and returns the non-matching value.</p>

<p>You can read more about <a href="https://hexdocs.pm/elixir/Kernel.SpecialForms.html#with/1"><code class="highlighter-rouge">with</code> in our documentation</a>.</p>

<h2 id="running-commands">Running commands</h2>

<p>The last step is to implement <code class="highlighter-rouge">KVServer.Command.run/1</code>, to run the parsed commands against the <code class="highlighter-rouge">:kv</code> application. Its implementation is shown below:</p>

<div class="language-elixir highlighter-rouge"><pre class="highlight"><code><span class="nv">@doc</span> <span class="sd">"""
Runs the given command.
"""</span>
<span class="k">def</span> <span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

<span class="k">def</span> <span class="n">run</span><span class="p">({</span><span class="ss">:create</span><span class="p">,</span> <span class="n">bucket</span><span class="p">})</span> <span class="k">do</span>
  <span class="no">KV</span><span class="o">.</span><span class="no">Registry</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="no">KV</span><span class="o">.</span><span class="no">Registry</span><span class="p">,</span> <span class="n">bucket</span><span class="p">)</span>
  <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="sd">"</span><span class="s2">OK\r\n"</span><span class="p">}</span>
<span class="k">end</span>

<span class="k">def</span> <span class="n">run</span><span class="p">({</span><span class="ss">:get</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">})</span> <span class="k">do</span>
  <span class="n">lookup</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="k">fn</span> <span class="n">pid</span> <span class="o">-&gt;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="no">KV</span><span class="o">.</span><span class="no">Bucket</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="sd">"</span><span class="si">#{</span><span class="n">value</span><span class="si">}</span><span class="s2">\r\nOK\r\n"</span><span class="p">}</span>
  <span class="k">end</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="n">run</span><span class="p">({</span><span class="ss">:put</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">})</span> <span class="k">do</span>
  <span class="n">lookup</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="k">fn</span> <span class="n">pid</span> <span class="o">-&gt;</span>
    <span class="no">KV</span><span class="o">.</span><span class="no">Bucket</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="sd">"</span><span class="s2">OK\r\n"</span><span class="p">}</span>
  <span class="k">end</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="n">run</span><span class="p">({</span><span class="ss">:delete</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">})</span> <span class="k">do</span>
  <span class="n">lookup</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="k">fn</span> <span class="n">pid</span> <span class="o">-&gt;</span>
    <span class="no">KV</span><span class="o">.</span><span class="no">Bucket</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="sd">"</span><span class="s2">OK\r\n"</span><span class="p">}</span>
  <span class="k">end</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">defp</span> <span class="n">lookup</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span> <span class="k">do</span>
  <span class="k">case</span> <span class="no">KV</span><span class="o">.</span><span class="no">Registry</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="no">KV</span><span class="o">.</span><span class="no">Registry</span><span class="p">,</span> <span class="n">bucket</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">pid</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="n">callback</span><span class="o">.</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="ss">:error</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="ss">:not_found</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Every function clause dispatches the appropriate command to the <code class="highlighter-rouge">KV.Registry</code> server that we registered during the <code class="highlighter-rouge">:kv</code> application startup. Since our <code class="highlighter-rouge">:kv_server</code> depends on the <code class="highlighter-rouge">:kv</code> application, it is completely fine to depend on the services it provides.</p>

<p>You might have noticed we have a function head, <code class="highlighter-rouge">def run(command)</code>, without a body. In the <a href="/getting-started/modules-and-functions#default-arguments">Modules and Functions</a> chapter, we learned that a bodiless function can be used to declare default arguments for a multi-clause function. Here is another use case where we use a function without a body to document what the arguments are.</p>

<p>Note that we have also defined a private function named <code class="highlighter-rouge">lookup/2</code> to help with the common functionality of looking up a bucket and returning its <code class="highlighter-rouge">pid</code> if it exists, <code class="highlighter-rouge"><span class="p">{</span><span class="err">:error,</span><span class="w"> </span><span class="err">:not_found</span><span class="p">}</span></code> otherwise.</p>

<p>By the way, since we are now returning <code class="highlighter-rouge"><span class="p">{</span><span class="err">:error,</span><span class="w"> </span><span class="err">:not_found</span><span class="p">}</span></code>, we should amend the <code class="highlighter-rouge">write_line/2</code> function in <code class="highlighter-rouge">KVServer</code> to print such error as well:</p>

<div class="language-elixir highlighter-rouge"><pre class="highlight"><code><span class="k">defp</span> <span class="n">write_line</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="ss">:not_found</span><span class="p">})</span> <span class="k">do</span>
  <span class="ss">:gen_tcp</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">NOT FOUND\r\n"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Our server functionality is almost complete. Only tests are missing. This time, we have left tests for last because there are some important considerations to be made.</p>

<p><code class="highlighter-rouge">KVServer.Command.run/1</code>’s implementation is sending commands directly to the server named <code class="highlighter-rouge">KV.Registry</code>, which is registered by the <code class="highlighter-rouge">:kv</code> application. This means this server is global and if we have two tests sending messages to it at the same time, our tests will conflict with each other (and likely fail). We need to decide between having unit tests that are isolated and can run asynchronously, or writing integration tests that work on top of the global state, but exercise our application’s full stack as it is meant to be exercised in production.</p>

<p>So far we have only written unit tests, typically testing a single module directly. However, in order to make <code class="highlighter-rouge">KVServer.Command.run/1</code> testable as a unit we would need to change its implementation to not send commands directly to the <code class="highlighter-rouge">KV.Registry</code> process but instead pass a server as an argument. For example, we would need to change <code class="highlighter-rouge">run</code>’s signature to <code class="highlighter-rouge">def run(command, pid)</code> and then change all clauses accordingly:</p>

<div class="language-elixir highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="n">run</span><span class="p">({</span><span class="ss">:create</span><span class="p">,</span> <span class="n">bucket</span><span class="p">},</span> <span class="n">pid</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">KV</span><span class="o">.</span><span class="no">Registry</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">bucket</span><span class="p">)</span>
  <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="sd">"</span><span class="s2">OK\r\n"</span><span class="p">}</span>
<span class="k">end</span>

<span class="c1"># ... other run clauses ...</span>
</code></pre>
</div>

<p>Feel free to go ahead and do the changes above and write some unit tests. The idea is that your tests will start an instance of the <code class="highlighter-rouge">KV.Registry</code> and pass it as an argument to <code class="highlighter-rouge">run/2</code> instead of relying on the global <code class="highlighter-rouge">KV.Registry</code>. This has the advantage of keeping our tests asynchronous as there is no shared state.</p>

<p>But let’s also try something different. Let’s write integration tests that rely on the global server names to exercise the whole stack from the TCP server to the bucket. Our integration tests will rely on global state and must be synchronous. With integration tests, we get coverage on how the components in our application work together at the cost of test performance. They are typically used to test the main flows in your application. For example, we should avoid using integration tests to test an edge case in our command parsing implementation.</p>

<p>Our integration test will use a TCP client that sends commands to our server and assert we are getting the desired responses.</p>

<p>Let’s implement the integration test in <code class="highlighter-rouge">test/kv_server_test.exs</code> as shown below:</p>

<div class="language-elixir highlighter-rouge"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">KVServerTest</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">ExUnit</span><span class="o">.</span><span class="no">Case</span>

  <span class="n">setup</span> <span class="k">do</span>
    <span class="no">Application</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="ss">:kv</span><span class="p">)</span>
    <span class="ss">:ok</span> <span class="o">=</span> <span class="no">Application</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="ss">:kv</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">setup</span> <span class="k">do</span>
    <span class="n">opts</span> <span class="o">=</span> <span class="p">[</span><span class="ss">:binary</span><span class="p">,</span> <span class="ss">packet:</span> <span class="ss">:line</span><span class="p">,</span> <span class="ss">active:</span> <span class="no">false</span><span class="p">]</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span> <span class="o">=</span> <span class="ss">:gen_tcp</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="m">4040</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
    <span class="p">%{</span><span class="ss">socket:</span> <span class="n">socket</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="n">test</span> <span class="sd">"</span><span class="s2">server interaction"</span><span class="p">,</span> <span class="p">%{</span><span class="ss">socket:</span> <span class="n">socket</span><span class="p">}</span> <span class="k">do</span>
    <span class="n">assert</span> <span class="n">send_and_recv</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">UNKNOWN shopping\r\n"</span><span class="p">)</span> <span class="o">==</span>
           <span class="sd">"</span><span class="s2">UNKNOWN COMMAND\r\n"</span>

    <span class="n">assert</span> <span class="n">send_and_recv</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">GET shopping eggs\r\n"</span><span class="p">)</span> <span class="o">==</span>
           <span class="sd">"</span><span class="s2">NOT FOUND\r\n"</span>

    <span class="n">assert</span> <span class="n">send_and_recv</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">CREATE shopping\r\n"</span><span class="p">)</span> <span class="o">==</span>
           <span class="sd">"</span><span class="s2">OK\r\n"</span>

    <span class="n">assert</span> <span class="n">send_and_recv</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">PUT shopping eggs 3\r\n"</span><span class="p">)</span> <span class="o">==</span>
           <span class="sd">"</span><span class="s2">OK\r\n"</span>

    <span class="c1"># GET returns two lines</span>
    <span class="n">assert</span> <span class="n">send_and_recv</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">GET shopping eggs\r\n"</span><span class="p">)</span> <span class="o">==</span> <span class="sd">"</span><span class="s2">3\r\n"</span>
    <span class="n">assert</span> <span class="n">send_and_recv</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">"</span><span class="p">)</span> <span class="o">==</span> <span class="sd">"</span><span class="s2">OK\r\n"</span>

    <span class="n">assert</span> <span class="n">send_and_recv</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">DELETE shopping eggs\r\n"</span><span class="p">)</span> <span class="o">==</span>
           <span class="sd">"</span><span class="s2">OK\r\n"</span>

    <span class="c1"># GET returns two lines</span>
    <span class="n">assert</span> <span class="n">send_and_recv</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">GET shopping eggs\r\n"</span><span class="p">)</span> <span class="o">==</span> <span class="sd">"</span><span class="s2">\r\n"</span>
    <span class="n">assert</span> <span class="n">send_and_recv</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">"</span><span class="p">)</span> <span class="o">==</span> <span class="sd">"</span><span class="s2">OK\r\n"</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">send_and_recv</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span> <span class="k">do</span>
    <span class="ss">:ok</span> <span class="o">=</span> <span class="ss">:gen_tcp</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">data</span><span class="p">}</span> <span class="o">=</span> <span class="ss">:gen_tcp</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">1000</span><span class="p">)</span>
    <span class="n">data</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Our integration test checks all server interaction, including unknown commands and not found errors. It is worth noting that, as with <abbr title="Erlang Term Storage">ETS</abbr> tables and linked processes, there is no need to close the socket. Once the test process exits, the socket is automatically closed.</p>

<p>This time, since our test relies on global data, we have not given <code class="highlighter-rouge">async: true</code> to <code class="highlighter-rouge">use ExUnit.Case</code>. Furthermore, in order to guarantee our test is always in a clean state, we stop and start the <code class="highlighter-rouge">:kv</code> application before each test. In fact, stopping the <code class="highlighter-rouge">:kv</code> application even prints a warning on the terminal:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>18:12:10.698 [info] Application kv exited: :stopped
</code></pre>
</div>

<p>To avoid printing log messages during tests, ExUnit provides a neat feature called <code class="highlighter-rouge">:capture_log</code>. By setting <code class="highlighter-rouge">@tag :capture_log</code> before each test or <code class="highlighter-rouge">@moduletag :capture_log</code> for the whole test case, ExUnit will automatically capture anything that is logged while the test runs. In case our test fails, the captured logs will be printed alongside the ExUnit report.</p>

<p>Between <code class="highlighter-rouge">use ExUnit.Case</code> and setup, add the following call:</p>

<div class="language-elixir highlighter-rouge"><pre class="highlight"><code><span class="nv">@moduletag</span> <span class="ss">:capture_log</span>
</code></pre>
</div>

<p>In case the test crashes, you will see a report as follows:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  1) test server interaction (KVServerTest)
     test/kv_server_test.exs:17
     ** (RuntimeError) oops
     stacktrace:
       test/kv_server_test.exs:29

     The following output was logged:

     13:44:10.035 [info]  Application kv exited: :stopped
</code></pre>
</div>

<p>With this simple integration test, we start to see why integration tests may be slow. Not only this test cannot run asynchronously, it also requires the expensive setup of stopping and starting the <code class="highlighter-rouge">:kv</code> application.</p>

<p>At the end of the day, it is up to you and your team to figure out the best testing strategy for your applications. You need to balance code quality, confidence, and test suite runtime. For example, we may start with testing the server only with integration tests, but if the server continues to grow in future releases, or it becomes a part of the application with frequent bugs, it is important to consider breaking it apart and writing more intensive unit tests that don’t have the weight of an integration test.</p>

<p>In the next chapter, we will finally make our system distributed by adding a bucket routing mechanism. We’ll also learn about application configuration.</p>

  </article><!-- .hfeed -->

  <div id="edit-on-github">
    <span>Is something wrong?</span>
    <a href="/edit/master/ja/getting-started/mix-otp/docs-tests-and-with.markdown">
      Edit this page on GitHub.
    </a>
  </div>

  
  
  
  
  

  
  
    
  
    
  
    
  

</div><!-- #content -->

      </div><!-- #main -->

      <div class="clear"></div>

      <div id="copyright">
        &copy; 2012–2018 <a href="http://plataformatec.com.br/">Plataformatec</a>. All rights reserved.
      </div>
    </div><!-- .wrap -->
  </div><!-- #container -->

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script src="/js/toc/toc.js" type="text/javascript" charset="utf-8"></script>
  <script type="text/javascript">
    $(document).ready(function() {
      $('.toc').toc({
        title: '',
        listType: 'ol',
        minimumHeaders: 2,
        headers: 'h2, h3, h4, h5, h6',
        linkHere: true,
        linkHereTitle: 'Link here',
        backToTop: true,
        backToTopId: 'toc',
        backToTopTitle: 'Back to Table of Contents',
      });
      $('.jekyll-toc-header a.jekyll-toc-link-here span.jekyll-toc-icon').addClass('icon icon-link');
      $('.jekyll-toc-header a.jekyll-toc-back-to-top span.jekyll-toc-icon').addClass('icon icon-chevron-up');
    });
  </script>
</body>
</html>

