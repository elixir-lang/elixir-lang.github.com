\documentclass[a4paper]{article}
\usepackage{framed}
\usepackage{tikz}
\usepackage{bm,times}
\usepackage{verbatim}
\usepackage[margin=1cm]{geometry}% for screen preview
\usetikzlibrary{shapes,arrows,calc,backgrounds,shapes.geometric}
% Define a background layer, in which the parchment shape is drawn
\pgfdeclarelayer{background}
\pgfsetlayers{background,main}

\tikzset{normal border/.style={orange!30!black!10}}

% Macro to draw the shape behind the text, when it fits
% completly in the page
\def\parchmentframe#1{
\tikz{
  \node[inner sep=2em] (A) {#1};  % Draw the text of the node
  \begin{pgfonlayer}{background}  % Draw the shape behind
  \filldraw[normal border,rounded corners=2em,color=blue!10!yellow!5,draw=blue!25!yellow,dashed]
        (A.south east) -- (A.south west) --
        (A.north west) -- (A.north east) -- cycle;
  \end{pgfonlayer}}}

% Macro to draw the shape, when the text will continue in next page
\def\parchmentframetop#1{
\tikz{
  \node[inner sep=2em] (A) {#1};    % Draw the text of the node
  \begin{pgfonlayer}{background}
  \filldraw[normal border,rounded corners,color=blue!10!yellow!5,draw=blue!25!yellow,dashed]
        (A.south east) -- (A.south west) --
        (A.north west) -- (A.north east) -- cycle;
  \end{pgfonlayer}}}

% Macro to draw the shape, when the text continues from previous page
\def\parchmentframebottom#1{
\tikz{
  \node[inner sep=2em] (A) {#1};   % Draw the text of the node
  \begin{pgfonlayer}{background}
  \filldraw[normal border,rounded corners,color=blue!10!yellow!5,draw=blue!25!yellow,dashed]
        (A.south east) -- (A.south west) --
        (A.north west) -- (A.north east) -- cycle;
  \end{pgfonlayer}}}

% Macro to draw the shape, when both the text continues from previous page
% and it will continue in next page
\def\parchmentframemiddle#1{
\tikz{
  \node[inner sep=2em] (A) {#1};   % Draw the text of the node
  \begin{pgfonlayer}{background}
  \filldraw[normal border,rounded corners,color=blue!10!yellow!5,draw=blue!25!yellow,dashed]
        (A.south east) -- (A.south west) --
        (A.north west) -- (A.north east) -- cycle;
  \end{pgfonlayer}}}

% Define the environment which puts the frame
% In this case, the environment also accepts an argument with an optional
% title (which defaults to ``Example'', which is typeset in a box overlaid
% on the top border
\newenvironment{parchment}[1][Example]{%
  \def\FrameCommand{\parchmentframe}%
  \def\FirstFrameCommand{\parchmentframetop}%
  \def\LastFrameCommand{\parchmentframebottom}%
  \def\MidFrameCommand{\parchmentframemiddle}%
  \vskip\baselineskip
  \MakeFramed {\FrameRestore}
  \noindent\tikz\node[rounded corners=2ex, inner sep=2ex, draw=blue!25!yellow, fill=white, dashed, anchor=west, overlay] at (0em, 2em) {\sffamily#1};\par}%
{\endMakeFramed}

\setlength\parindent{0pt}

% Main document, example of usage
\pagestyle{empty}
\begin{document}

% We need layers to draw the block diagram
\pgfdeclarelayer{background}
\pgfdeclarelayer{foreground}
\pgfsetlayers{background,main,foreground}

% Define a few styles and constants
\tikzstyle{left-title}=[draw, fill=blue!20, text width=1em, minimum height=5em]
\tikzstyle{main-block} = [left-title, text width=30em, inner sep=8pt, fill=red!10, minimum height=5em, rounded corners]
\tikzstyle{immediate} = [left-title, text width=16em, inner sep=8pt, fill=red!10, minimum height=5em, rounded corners]

\begin{comment}
\begin{parchment}[initialization]
  Gallia est omnis divisa in partes tres, quarum unam incolunt Belgae, aliam Aquitani, tertiam qui ipsorum lingua Celtae, nostra Galli appellantur. Hi omnes lingua, institutis, legibus inter se differunt. Gallos ab Aquitanis Garumna flumen, a Belgis Matrona et Sequana dividit. Horum omnium fortissimi sunt Belgae, propterea quod a cultu atque humanitate provinciae longissime absunt, minimeque ad eos mercatores saepe commeant atque ea quae ad effeminandos animos pertinent important, proximique sunt Germanis, qui trans Rhenum incolunt, quibuscum continenter bellum gerunt. Qua de causa Helvetii quoque reliquos Gallos virtute praecedunt, quod fere cotidianis proeliis cum Germanis contendunt, cum aut suis finibus eos prohibent aut ipsi in eorum finibus bellum gerunt. Eorum una pars, quam Gallos obtinere dictum est, initium capit a flumine Rhodano, continetur Garumna flumine, Oceano, finibus Belgarum, attingit etiam ab Sequanis et Helvetiis flumen Rhenum, vergit ad septentriones. Belgae ab extremis Galliae finibus oriuntur, pertinent ad inferiorem partem fluminis Rheni, spectant in septentrionem et orientem solem. Aquitania a Garumna flumine ad Pyrenaeos montes et eam partem Oceani quae est ad Hispaniam pertinet; spectat inter occasum solis et septentriones.
\end{parchment}
\end{comment}
\begin{parchment}[initialization]
\begin{tikzpicture}
  \node (client) [main-block] {%
    \vspace*{-\baselineskip}
\begin{verbatim}
def start_link(opts \\ []) do
  GenServer.start_link(__MODULE__, :ok, opts)
end
\end{verbatim}
};
\path (client.180)+(-1em,0) node (gyros) [left-title] {\rotatebox{90}{client}};

\path (client.north east)+(3em,0) node (returns) [immediate,anchor=north west] {
    \vspace*{-\baselineskip}
\begin{verbatim}
{:ok, pid}
\end{verbatim}
};
  \path (returns.180)+(-1em,0) node (gyros) [left-title] {\rotatebox{90}{immediate}};

\path (client.south west)+(0,-1em) node (callback) [main-block,anchor=north west] {
    \vspace*{-\baselineskip}
\begin{verbatim}
def init(:ok) do
  # initialize state, or fail to do so
  return_value
end
\end{verbatim}
};
  \path (callback.180)+(-1em,0) node (gyros) [left-title] {\rotatebox{90}{callback}};

  \path (callback.south west)+(0,-1em) node (return-value) [main-block,anchor=north west] {
    \vspace*{-\baselineskip}
\begin{verbatim}
{:ok, state}
{:ok, state, 5_000}
{:ok, state, :hibernate}
{:stop, reason}
:ignore!
\end{verbatim}
};
\path (return-value.180)+(-1em,0) node (gyros) [left-title] {\rotatebox{90}{\^{}return\_value = }};

\path (return-value.south east)+(3em,0) node (reason) [immediate,anchor=south west] {
  This applies to all callback replies when \verb|return_value| matches \verb|{:stop, reason}|, and to \verb|reason| argument in \verb|stop| message.

\begin{verbatim}
:normal
:shutdown
{:shutdown, term}
term
\end{verbatim}
};
\path (reason.180)+(-1em,0) node (gyros) [left-title] {\rotatebox{90}{\^{}reason = }};

\end{tikzpicture}
\end{parchment}

\begin{parchment}[termination]
\begin{tikzpicture}
  \node (client) [main-block] {%
    \vspace*{-\baselineskip}
\begin{verbatim}
def stop(pid, reason \\ :normal,
                        timeout \\ :infinity) do
  GenServer.stop(pid, reason, timeout)
end
\end{verbatim}
};
\path (client.180)+(-1em,0) node (gyros) [left-title] {\rotatebox{90}{client}};

\path (client.north east)+(3em,0) node (returns) [immediate,anchor=north west] {
    \vspace*{-\baselineskip}
\begin{verbatim}
:ok
\end{verbatim}
};
\path (returns.180)+(-1em,0) node (gyros) [left-title] {\rotatebox{90}{immediate}};

\path (client.south west)+(0,-1em) node (callback) [main-block,anchor=north west] {
    \vspace*{-\baselineskip}
\begin{verbatim}
def terminate(reason, state) do
  # Perform cleanup
  # no return value expected
end
\end{verbatim}
};
  \path (callback.180)+(-1em,0) node (gyros) [left-title] {\rotatebox{90}{callback}};

\end{tikzpicture}
\end{parchment}

\begin{parchment}[synchronous operation]
\begin{tikzpicture}
  \node (client) [main-block] {
    \vspace*{-\baselineskip}
\begin{verbatim}
def sync_op(pid, args) do
  GenServer.call(pid, {:sync_op, args})
end
\end{verbatim}
};
  \path (client.180)+(-1em,0) node (gyros) [left-title] {\rotatebox{90}{client}};

\path (client.north east)+(3em,0) node (returns) [immediate,anchor=north west] {
  waits for callback and returns \verb|reply| if returned value from callback matches \verb|{:reply, reply, _}|
};
  \path (returns.180)+(-1em,0) node (gyros) [left-title] {\rotatebox{90}{immediate}};

  \path (client.south west)+(0,-1em) node (callback) [main-block,anchor=north west] {
    \vspace*{-\baselineskip}
\begin{verbatim}
def handle_call({:sync_op, args}, from, state) do
  new_state = f(state, args)
  return_value
end
\end{verbatim}
};
  \path (callback.180)+(-1em,0) node (gyros) [left-title] {\rotatebox{90}{callback}};

  \path (callback.south west)+(0,-1em) node (returns) [main-block,anchor=north west] {
    \vspace*{-\baselineskip}
\begin{verbatim}
{:reply, reply, new_state}
{:reply, reply, new_state, 5_000}
{:reply, reply, new_state, :hibernate}
\end{verbatim}

\rule{\linewidth}{0.4pt}

\begin{verbatim}
{:noreply, new_state}
{:noreply, new_state, 5_000}
{:noreply, new_state, :hibernate}
{:stop, reason , reply, new_state}
{:stop, reason , new_state}
\end{verbatim}
};

  \path (returns.180)+(-1em,0) node (gyros) [left-title] {\rotatebox{90}{\^{}return\_value =}};

\end{tikzpicture}

\end{parchment}

\begin{parchment}[asynchronous operation]
\begin{tikzpicture}
  \node (client) [main-block] {
    \vspace*{-\baselineskip}
\begin{verbatim}
def sync_op(pid, args) do
  GenServer.cast(pid, {:async_op, args})
end
\end{verbatim}
};
  \path (client.180)+(-1em,0) node (gyros) [left-title] {\rotatebox{90}{client}};

\path (client.north east)+(3em,0) node (returns) [immediate,anchor=north west] {
    \vspace*{-\baselineskip}
\begin{verbatim}
:ok
\end{verbatim}
};
  \path (returns.180)+(-1em,0) node (gyros) [left-title] {\rotatebox{90}{immediate}};

  \path (client.south west)+(0,-1em) node (callback) [main-block,anchor=north west] {
    \vspace*{-\baselineskip}
\begin{verbatim}
def handle_cast({:async_op, args}, state) do
  # compute new state or fail to do so
  return_value
end
\end{verbatim}
};
  \path (callback.180)+(-1em,0) node (gyros) [left-title] {\rotatebox{90}{callback}};

  \path (callback.south west)+(0,-1em) node (returns) [main-block,anchor=north west] {
    \vspace*{-\baselineskip}
\begin{verbatim}
{:noreply, new_state}
{:noreply, new_state, 5_000}
{:noreply, new_state, :hibernate}

{:stop, reason , new_state}
\end{verbatim}
};
  \path (returns.180)+(-1em,0) node (gyros) [left-title] {\rotatebox{90}{\^{}return\_value =}};

\end{tikzpicture}
\end{parchment}

\begin{parchment}[handling information messages]
\begin{tikzpicture}
  \node (client) [main-block] {
    \vspace*{-\baselineskip}
\begin{verbatim}
def handle_info(msg, state) do
  # compute new state or fail to do so
  return_value
end
\end{verbatim}
};
  \path (client.180)+(-1em,0) node (gyros) [left-title] {\rotatebox{90}{client}};

  \path (client.south west)+(0,-1em) node (returns) [main-block,anchor=north west] {
    \vspace*{-\baselineskip}
\begin{verbatim}
{:noreply, new_state}
{:noreply, new_state, 5_000}
{:noreply, new_state, :hibernate}

{:stop, reason , new_state}
\end{verbatim}
};
  \path (returns.180)+(-1em,0) node (gyros) [left-title] {\rotatebox{90}{\^{}return\_value =}};
\end{tikzpicture}
\end{parchment}

\begin{parchment}[other]
  I defined a module with one  \verb|abc| function, preceded by the \verb|@impl true| directive, as to force the compiler to give me the list of callback functions I could correctly define.

  This first block we have handled.
\begin{verbatim}
  * GenServer.init/1 (function)
  * GenServer.terminate/2 (function)
  * GenServer.handle_call/3 (function)
  * GenServer.handle_cast/2 (function)
  * GenServer.handle_info/2 (function)
\end{verbatim}

Who can fill in the blanks for the following three functions?
\begin{verbatim}
  * GenServer.code_change/3 (function)
  * GenServer.format_status/2 (function)
  * GenServer.handle_continue/2 (function)
\end{verbatim}
\end{parchment}

\end{document}
